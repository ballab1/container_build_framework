#!/bin/bash
#############################################################################
#
#   uidgid.bashlib
#
#############################################################################

function uidgid.check()
{
    local -a files=${1:?'Input parameter "files" must be defined'}

    for file in ${files} ; do
        lib.copyFileToRuntimeEnvironment "$file"
        chmod 755 "$file"
        $LOG "..executing ${file}${LF}" 'info'
        eval uidgid.createUserAndGroup "$file" || $LOG "..*** issue while executing $( basename "$file" ) ***${LF}" 'warn'
    done
}

#############################################################################
function uidgid.createUserAndGroup()
{
    local -r file=${1:?'Input parameter "file" must be defined'}

    source "$file"

    #strip path & prefix from file to get name
    local name="$( basename "$file" )"
    name="${name//[0-9]/}"
    name="${name#.}"

    local user="$( lib.indirectReference $name 'user' )"
    local uid="$( lib.indirectReference $name 'uid' )"
    local group="$( lib.indirectReference $name 'group' )"
    local gid="$( lib.indirectReference $name 'gid' )"
    local homedir="$( lib.indirectReference $name 'home' )"
    local shell="$( lib.indirectReference $name 'shell' )"

    if [ -z "$user" ] || [ -z "$uid" ] || [ -z "$group" ] || [ -z "$gid" ]; then
        trap.die "Invalid user/group specified in '${file}'; user: '${user}', uid: '${uid}', group: '$group', gid: '${gid}'"
    fi
   
    local wanted=$( printf '%s:%s' $group $gid )
    local nameMatch=$( getent group "${group}" | awk -F ':' '{ printf "%s:%s",$1,$3 }' )
    local idMatch=$( getent group "${gid}" | awk -F ':' '{ printf "%s:%s",$1,$3 }' )
    $LOG "INFO: group/gid (${wanted}):  is currently (${nameMatch})/(${idMatch})${LF}" 'info'

    if [[ $wanted != $nameMatch  ||  $wanted != $idMatch ]]; then
        if [[ "$idMatch" ]]; then
            local oldName=$( getent group "${gid}" | awk -F ':' '{ printf "%s",$1 }' )
            $LOG "renaming group:  ${oldName} to ${group}${LF}" 'info'
            /usr/sbin/groupmod --new-name "$group" "$oldName"
        elif [[ "$nameMatch" ]]; then
            local oldId=$( getent group "${group}" | awk -F ':' '{ printf "%s",$3 }' )
            $LOG "renaming group:  ${oldId} to ${gid}${LF}" 'info'
            /usr/sbin/groupmod --gid ${gid} "$group"
        else
            $LOG "create group:  ${group}${LF}" 'info'
            /usr/sbin/groupadd --gid "${gid}" "${group}"
        fi
    fi

    
    wanted=$( printf '%s:%s' $user $uid )
    nameMatch=$( getent passwd "${user}" | awk -F ':' '{ printf "%s:%s",$1,$3 }' )
    idMatch=$( getent passwd "${uid}" | awk -F ':' '{ printf "%s:%s",$1,$3 }' )
    $LOG "INFO: user/uid (${wanted}):  is currently (${nameMatch})/(${idMatch})${LF}" 'info'
    
    if [[ $wanted != $nameMatch  ||  $wanted != $idMatch ]]; then
        if [[ -z "$idMatch"  &&  -n "$nameMatch" ]]; then
            $LOG "update user:  ${user}${LF}" 'info'
            if [ "$homedir" ]; then
                [ -d "$homedir" ] || mkdir -p "$homedir"
                /usr/sbin/usermod --home "$homedir" --uid "${uid}" --gid "${gid}" --shell "${shell}" "${user}"
            else
                /usr/sbin/usermod --uid "${uid}" --gid "${gid}" --shell "${shell}" "${user}"
            fi
        else
            $LOG "create user: ${user}${LF}" 'info'
            [[ "$nameMatch"  &&  $wanted != $nameMatch ]] && userdel "$( getent passwd ${user} |  cut -d: -f1 )"
            [[ "$idMatch"    &&  $wanted != $idMatch ]]   && userdel "$( getent passwd ${uid} |  cut -d: -f1 )"
            if [ "$homedir" ]; then
                [ -d "$homedir" ] || mkdir -p "$homedir"
                /usr/sbin/useradd --home-dir "$homedir" --uid "${uid}" --gid "${gid}" --shell "${shell}" "${user}"
            else
                /usr/sbin/useradd --no-create-home --uid "${uid}" --gid "${gid}" --shell "${shell}" "${user}"
            fi
        fi
    fi
} 