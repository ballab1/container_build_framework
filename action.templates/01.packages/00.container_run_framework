#!/bin/bash

# copy runtime framework (only copy updates)
mkdir -p "${CBF['crt_base']}"
cd "${CBF['crf_base']}"

#ensure crf directories exist
while read -r dir; do
    mkdir -p "${CBF['crt_base']}/$dir"
done < <(find . -maxdepth 1 -mindepth 1 -type d ! -name '.*')

declare -i val

# copy runtime framework (only copy updates)
while read -r file ; do
    if [ -e "${CBF['crt_base']}/$file" ]; then
        $( ! cmp -s "$file" "${CBF['crt_base']}/$file" ) || continue
        echo "updating ${CBF['crt_base']}/$file"
    fi
    mkdir -p "$( dirname "${CBF['crt_base']}/$file" )"
    cp "$file" "${CBF['crt_base']}/$file"
done< <(find . -type f ! -name '.*')

# create docker-entrypoint.sh from copy default entrypoint script if none exists
if [ ! -e "${CBF['base']}/usr/local/bin/docker-entrypoint.sh" ]; then
    mkdir -p /usr/local/bin
    echo 'Creating docker-entrypoint.sh'
    sed "s/newcontainer/${CONTAINER_NAME}/gi" "${CBF['crf_bin']}/default.entrypoint" > /usr/local/bin/docker-entrypoint.sh
fi
