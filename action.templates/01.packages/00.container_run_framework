#!/bin/bash

##########################################################
#
#  setup the 'container runtime framework' (CRF)
#
##########################################################


# copy runtime framework (only copy updates)
mkdir -p "${CBF['crt_base']}"
cd "${CBF['crf_base']}"

#ensure crf directories exist
while read -r dir; do
    mkdir -p "${CBF['crt_base']}/$dir"
done < <(find . -maxdepth 1 -mindepth 1 -type d ! -name '.*')

declare -i val

# copy runtime framework (only copy updates)
while read -r file ; do
    if [ -e "${CBF['crt_base']}/$file" ]; then
        $( ! cmp -s "$file" "${CBF['crt_base']}/$file" ) || continue
        echo "updating ${CBF['crt_base']}/$file"
    fi
    mkdir -p "$( dirname "${CBF['crt_base']}/$file" )"
    cp "$file" "${CBF['crt_base']}/$file"
done< <(find . -type f ! -name '.*')


# create docker-entrypoint.sh from copy default entrypoint script if none exists to invoke the CRF
if [ ! -e "${CBF['base']}/override.entrypoint" ]; then
    # this may get refactored into processing of 'container.properties'
    if [ ! -e /usr/local/bin/docker-entrypoint.sh ]; then
        mkdir -p /usr/local/bin
        echo 'Creating docker-entrypoint.sh'
        cp "${CBF['crf_bin']}/default.entrypoint" /usr/local/bin/docker-entrypoint.sh

    elif [ -e "${CBF['base']}/usr/local/bin/docker-entrypoint.sh" ]; then 
        echo 'Potential conflict detected with existing file: /usr/local/bin/docker-entrypoint.sh'
        echo 'To prevent this error, either:'
        echo "    remove the file:       ${CBF['base']}/usr/local/bin/docker-entrypoint.sh"
        echo "    or create an override: ${CBF['base']}/override.entrypoint"
        exit 1
    fi
    sed -i "s|^declare -rx CONTAINER_NAME=.*$|declare -rx CONTAINER_NAME=${CONTAINER_NAME}|" /usr/local/bin/docker-entrypoint.sh
fi    



# setup some variables based on runtime properties in the Dockerfile 
declare props=/tmp/container.properties
if [ -e "$props" ]; then
    while IFS='=' read -r key value; do
        case "$key" in
            entrypoint) declare entrypoint="$val";;
            command)    declare cmd="$val";;
            volumes)    declare volumes="$val";;
            user)       declare user="$val";;
            workdir)    declare workdir="$val";;
        esac
    done < "$props"
    
fi
